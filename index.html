<!DOCTYPE html>
<html lang="en" ng-app="kitchensink">

<head>
    <meta charset="utf-8">

    <title>Free drawing | Fabric.js Demos</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.js" integrity="sha512-+k1pnlgt4F1H8L7t3z95o3/KO+o78INEcXTbnoJQ/F2VqDVhWoaiVml/OEHv9HsVgxUaVW+IbiZPUJQfF/YxZw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

    <script src="./fabric.js"></script>
    <script src="https://unpkg.com/fabric@latest/src/mixins/eraser_brush.mixin.js"></script>
    <script src="./filler.js"></script>
    <script src="./history.js"></script>
    <script src="./paint.brush.js"></script>
    <script src="./image.brush.js"></script>
    <script src="./shape.brush.js"></script>
   <style>
        body{
            margin: 0px;
        }
        #drawing-mode {
            margin-bottom: 10px;
            vertical-align: top;
        }

        #drawing-mode-options {
            display: inline-block;
            vertical-align: top;
            margin-bottom: 10px;
            margin-top: 10px;
            background: #f5f2f0;
            padding: 10px;
        }

        label {
            display: inline-block;
            width: 130px;
        }

        .info {
            display: inline-block;
            width: 25px;
            background: #ffc;
        }

        #bd-wrapper {
            min-width: 1500px;
        }

        #tooInfo {
            position: absolute;
            right: 0px;
            top: 0px;
        }
    </style>
</head>

<body>
    <div id="bd-wrapper" >
        <canvas id="c"  style="border:1px solid #aaa"></canvas>

        <div id="tooInfo" style="display: inline-block; margin-left: 10px">
            <button id="drawing-mode" class="btn btn-info">Cancel drawing mode</button><br>
            <button id="clear-canvas" class="btn btn-info">Clear</button><br>

            <div id="drawing-mode-options">
                <label for="drawing-mode-selector">Mode:</label>
                <select id="drawing-mode-selector">
                    <option>Pencil</option>
                    <option>paint</option>
                    <option>frog</option>
                    <option>eraser</option>
                    <option>Circle</option>
                    <option>Spray</option>
                    <option>Pattern</option>

                    <option>hline</option>
                    <option>vline</option>
                    <option>square</option>
                    <option>diamond</option>
                    <option>texture</option>
                </select><br>

                <label for="drawing-line-width">Line width:</label>
                <span class="info">30</span><input type="range" value="30" min="0" max="150"
                    id="drawing-line-width"><br>

                <label for="drawing-color">Line color:</label>
                <input type="color" value="#005E7A" id="drawing-color"><br>

                <label for="drawing-shadow-color">Shadow color:</label>
                <input type="color" value="#005E7A" id="drawing-shadow-color"><br>

                <label for="drawing-shadow-width">Shadow width:</label>
                <span class="info">0</span><input type="range" value="0" min="0" max="50" id="drawing-shadow-width"><br>

                <label for="drawing-shadow-offset">Shadow offset:</label>
                <span class="info">0</span><input type="range" value="0" min="0" max="50"
                    id="drawing-shadow-offset"><br>
                    <button id="undo">Undo</button>
                <button id="redo" >Redo</button>
            </div>
        </div>
        <br />
        <br />
        <script id="main">(function () {
        
                var $ = function (id) { return document.getElementById(id) };
            
                var canvas = this.__canvas = new fabric.Canvas('c', {
                    isDrawingMode: true,
                    width:window.innerWidth-400,
                    height:window.innerHeight-100
                });

                fabric.Object.prototype.transparentCorners = false;
                // fabric.Image.fromURL('https://www.shutterstock.com/image-vector/cute-funny-coloring-page-rocket-600nw-1893601582.jpg', function(img) {
                //     img.set({
                //         left: 0,
                //         top: 0,
                //     });
                //     canvas.add(img);
                //     canvas.renderAll();
                //     },{crossOrigin: 'anonymous'});
                var drawingModeEl = $('drawing-mode'),
                    drawingOptionsEl = $('drawing-mode-options'),
                    drawingColorEl = $('drawing-color'),
                    drawingShadowColorEl = $('drawing-shadow-color'),
                    drawingLineWidthEl = $('drawing-line-width'),
                    drawingShadowWidth = $('drawing-shadow-width'),
                    drawingShadowOffset = $('drawing-shadow-offset'),
                    undo = $('undo'),
                    redo = $('redo'),
                    clearEl = $('clear-canvas');

                clearEl.onclick = function () { canvas.clear() };
                undo.onclick = function () { canvas.undo() };
                redo.onclick = function () { canvas.redo() };

                drawingModeEl.onclick = function () {
                    canvas.isDrawingMode = !canvas.isDrawingMode;
                    if (canvas.isDrawingMode) {
                        drawingModeEl.innerHTML = 'Cancel drawing mode';
                        drawingOptionsEl.style.display = '';
                    }
                    else {
                        drawingModeEl.innerHTML = 'Enter drawing mode';
                        drawingOptionsEl.style.display = 'none';
                    }
                };

                if (fabric.PatternBrush) {
                    var texturePatternBrush;
                    const img = new Image();
                    img.src = "./mJIRnVw.png";
                    img.onload = () => {
                           texturePatternBrush  = new fabric.PatternBrush(canvas);
                            texturePatternBrush.source = img;
                            console.log("image loaded")
                    };
                    var vLinePatternBrush = new fabric.PatternBrush(canvas);
                    vLinePatternBrush.getPatternSrc = function () {

                        var patternCanvas = fabric.document.createElement('canvas');
                        patternCanvas.width = patternCanvas.height = 10;
                        var ctx = patternCanvas.getContext('2d');

                        ctx.strokeStyle = this.color;
                        ctx.lineWidth = 5;
                        ctx.beginPath();
                        ctx.moveTo(0, 5);
                        ctx.lineTo(10, 5);
                        ctx.closePath();
                        ctx.stroke();

                        return patternCanvas;
                    };

                    var hLinePatternBrush = new fabric.PatternBrush(canvas);
                    hLinePatternBrush.getPatternSrc = function () {

                        var patternCanvas = fabric.document.createElement('canvas');
                        patternCanvas.width = patternCanvas.height = 10;
                        var ctx = patternCanvas.getContext('2d');

                        ctx.strokeStyle = this.color;
                        ctx.lineWidth = 5;
                        ctx.beginPath();
                        ctx.moveTo(5, 0);
                        ctx.lineTo(5, 10);
                        ctx.closePath();
                        ctx.stroke();

                        return patternCanvas;
                    };

                    var squarePatternBrush = new fabric.PatternBrush(canvas);
                    squarePatternBrush.getPatternSrc = function () {

                        var squareWidth = 10, squareDistance = 2;

                        var patternCanvas = fabric.document.createElement('canvas');
                        patternCanvas.width = patternCanvas.height = squareWidth + squareDistance;
                        var ctx = patternCanvas.getContext('2d');

                        ctx.fillStyle = this.color;
                        ctx.fillRect(0, 0, squareWidth, squareWidth);

                        return patternCanvas;
                    };

                    var diamondPatternBrush = new fabric.PatternBrush(canvas);
                    diamondPatternBrush.getPatternSrc = function () {

                        var squareWidth = 10, squareDistance = 5;
                        var patternCanvas = fabric.document.createElement('canvas');
                        var rect = new fabric.Rect({
                            width: squareWidth,
                            height: squareWidth,
                            angle: 45,
                            fill: this.color
                        });

                        var canvasWidth = rect.getBoundingRect().width;

                        patternCanvas.width = patternCanvas.height = canvasWidth + squareDistance;
                        rect.set({ left: canvasWidth / 2, top: canvasWidth / 2 });

                        var ctx = patternCanvas.getContext('2d');
                        rect.render(ctx);

                        return patternCanvas;
                    };

                    
                  
                }

                $('drawing-mode-selector').onchange = function () {

                    if (this.value === 'hline') {
                        canvas.freeDrawingBrush = vLinePatternBrush;
                    }
                    else if (this.value === 'vline') {
                        canvas.freeDrawingBrush = hLinePatternBrush;
                    }
                    else if (this.value === 'square') {
                        canvas.freeDrawingBrush = squarePatternBrush;
                    }
                    else if (this.value === 'diamond') {
                        canvas.freeDrawingBrush = diamondPatternBrush;
                    }
                    else if (this.value === 'texture') {
                        canvas.freeDrawingBrush = texturePatternBrush;
                    }
                    else if (this.value === 'paint') {  
                        canvas.freeDrawingBrush = new fabric.PaintBucket(canvas);
                    }
                    else if (this.value === 'eraser') {  
                        canvas.freeDrawingBrush = new fabric.EraserBrush(canvas);
                    }
                    else if (this.value === 'frog') {  
                        canvas.freeDrawingBrush = new fabric.ImageBrush(canvas,'./frog.jpg','./frog.mp3');
                    }
                    else {
                        canvas.freeDrawingBrush = new fabric[this.value + 'Brush'](canvas);
                    }

                    if (canvas.freeDrawingBrush) {
                        var brush = canvas.freeDrawingBrush;
                        brush.color = drawingColorEl.value;
                        if (brush.getPatternSrc && this.value != 'texture') {
                            brush.source = brush.getPatternSrc.call(brush);
                        }else{
                            console.log("check")
                        }
                        brush.width = this.value == 'texture' ?  50 : (parseInt(drawingLineWidthEl.value, 10) || 1);
                        brush.shadow = new fabric.Shadow({
                            blur: parseInt(drawingShadowWidth.value, 10) || 0,
                            offsetX: 0,
                            offsetY: 0,
                            affectStroke: true,
                            color: drawingShadowColorEl.value,
                        });
                    }
                };

                drawingColorEl.onchange = function () {
                    var brush = canvas.freeDrawingBrush;
                    brush.color = this.value;
                    if (brush.getPatternSrc) {
                        brush.source = brush.getPatternSrc.call(brush);
                    }
                };
                drawingShadowColorEl.onchange = function () {
                    canvas.freeDrawingBrush.shadow.color = this.value;
                };
                drawingLineWidthEl.onchange = function () {
                    canvas.freeDrawingBrush.width = parseInt(this.value, 10) || 1;
                    this.previousSibling.innerHTML = this.value;
                };
                drawingShadowWidth.onchange = function () {
                    canvas.freeDrawingBrush.shadow.blur = parseInt(this.value, 10) || 0;
                    this.previousSibling.innerHTML = this.value;
                };
                drawingShadowOffset.onchange = function () {
                    canvas.freeDrawingBrush.shadow.offsetX = parseInt(this.value, 10) || 0;
                    canvas.freeDrawingBrush.shadow.offsetY = parseInt(this.value, 10) || 0;
                    this.previousSibling.innerHTML = this.value;
                };

                if (canvas.freeDrawingBrush) {
                    canvas.freeDrawingBrush.color = drawingColorEl.value;
                    canvas.freeDrawingBrush.source = canvas.freeDrawingBrush.getPatternSrc.call(this);
                    canvas.freeDrawingBrush.width = parseInt(drawingLineWidthEl.value, 10) || 1;
                    canvas.freeDrawingBrush.shadow = new fabric.Shadow({
                        blur: parseInt(drawingShadowWidth.value, 10) || 0,
                        offsetX: 0,
                        offsetY: 0,
                        affectStroke: true,
                        color: drawingShadowColorEl.value,
                    });
                }
            })();
        </script>

    </div>




</body>

</html>